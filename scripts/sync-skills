#!/usr/bin/env bash
# sync-skills - Sync skills to Claude, Codex, and Gemini
#
# Usage:
#   sync-skills                       # Sync from default source
#   sync-skills --dry-run             # Preview what would be synced
#   sync-skills --src /path/to/skills # Sync from custom source
#   sync-skills --prune               # Remove extra skills from destinations
#   sync-skills --help                # Show help
#
set -euo pipefail

VERSION="1.1.0"

# -----------------------------------------------------------------------------
# Configuration
# -----------------------------------------------------------------------------
GLOBAL_SKILLS_DIR="$HOME/projects/agent-scripts/skills"

# -----------------------------------------------------------------------------
# Colors (fallback when gum not available)
# -----------------------------------------------------------------------------
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# Gum availability flag
GUM_AVAILABLE=false

# -----------------------------------------------------------------------------
# Gum auto-installation
# -----------------------------------------------------------------------------
try_install_gum() {
    if [[ "$(uname -s)" != "Darwin"* ]]; then
        return 1
    fi

    echo -e "${BLUE}â†’${NC} Installing gum for prettier output..."

    if command -v brew &> /dev/null; then
        brew install gum &>/dev/null && return 0
    fi

    return 1
}

check_gum() {
    if command -v gum &> /dev/null; then
        GUM_AVAILABLE=true
        return 0
    fi

    # Try to install gum via brew
    if try_install_gum && command -v gum &> /dev/null; then
        GUM_AVAILABLE=true
        return 0
    fi

    return 1
}

# -----------------------------------------------------------------------------
# Styled output functions
# -----------------------------------------------------------------------------
print_banner() {
    if [[ "$GUM_AVAILABLE" == "true" ]]; then
        gum style \
            --border rounded \
            --border-foreground 212 \
            --padding "0 2" \
            --margin "1 0" \
            --bold \
            "ğŸ”„ sync-skills v${VERSION}" \
            "Sync skills to Claude, Codex & Gemini"
    else
        echo -e "\n${BOLD}${MAGENTA}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
        echo -e "${BOLD}${MAGENTA}â”‚${NC}  ${BOLD}ğŸ”„ sync-skills v${VERSION}${NC}                     ${BOLD}${MAGENTA}â”‚${NC}"
        echo -e "${BOLD}${MAGENTA}â”‚${NC}  ${DIM}Sync skills to Claude, Codex & Gemini${NC}  ${BOLD}${MAGENTA}â”‚${NC}"
        echo -e "${BOLD}${MAGENTA}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}\n"
    fi
}

log_info() {
    if [[ "$GUM_AVAILABLE" == "true" ]]; then
        gum style --foreground 39 "â„¹ $1"
    else
        echo -e "${GREEN}[info]${NC} $1"
    fi
}

log_warn() {
    if [[ "$GUM_AVAILABLE" == "true" ]]; then
        gum style --foreground 214 "âš  $1"
    else
        echo -e "${YELLOW}[warn]${NC} $1"
    fi
}

log_error() {
    if [[ "$GUM_AVAILABLE" == "true" ]]; then
        gum style --foreground 196 "âœ— $1"
    else
        echo -e "${RED}[error]${NC} $1" >&2
    fi
}

log_success() {
    if [[ "$GUM_AVAILABLE" == "true" ]]; then
        gum style --foreground 82 "âœ“ $1"
    else
        echo -e "${GREEN}âœ“${NC} $1"
    fi
}

log_step() {
    if [[ "$GUM_AVAILABLE" == "true" ]]; then
        gum style --foreground 39 "â†’ $1"
    else
        echo -e "${BLUE}â†’${NC} $1"
    fi
}

show_help() {
    check_gum || true

    if [[ "$GUM_AVAILABLE" == "true" ]]; then
        gum style \
            --border rounded \
            --border-foreground 212 \
            --padding "0 2" \
            --margin "1 0" \
            --bold \
            "ğŸ”„ sync-skills v${VERSION}"

        echo ""
        gum style --foreground 214 --bold "SYNOPSIS"
        echo "  sync-skills [OPTIONS]"
        echo ""

        gum style --foreground 214 --bold "DESCRIPTION"
        gum style --padding "0 2" "Sync skills from source directory to Claude, Codex, and
Gemini skill directories."
        echo ""

        gum style --foreground 214 --bold "OPTIONS"
        gum style --foreground 82 "  --src PATH"
        gum style --foreground 245 "      Source skills directory (default: $GLOBAL_SKILLS_DIR)"
        gum style --foreground 82 "  --dry-run, -n"
        gum style --foreground 245 "      Preview changes without modifying anything"
        gum style --foreground 82 "  --prune"
        gum style --foreground 245 "      Remove skills in destinations not present in source"
        gum style --foreground 82 "  --help, -h"
        gum style --foreground 245 "      Show this help message"
        echo ""

        gum style --foreground 214 --bold "EXAMPLES"
        gum style --foreground 39 "  # Sync from default location"
        echo "  sync-skills"
        echo ""
        gum style --foreground 39 "  # Sync from custom source"
        echo "  sync-skills --src /path/to/skills"
    else
        echo -e "${BOLD}sync-skills${NC} v${VERSION}"
        echo ""
        echo "Sync skills to Claude, Codex & Gemini"
        echo ""
        echo "USAGE:"
        echo "  sync-skills [OPTIONS]"
        echo ""
        echo "OPTIONS:"
        echo "  --src PATH      Source skills directory (default: $GLOBAL_SKILLS_DIR)"
        echo "  --dry-run, -n   Preview changes without modifying anything"
        echo "  --prune         Remove skills in destinations not present in source"
        echo "  --help, -h      Show this help message"
        echo ""
        echo "EXAMPLES:"
        echo "  sync-skills                          # from default location"
        echo "  sync-skills --src /path/to/skills    # from custom source"
    fi
}

# -----------------------------------------------------------------------------
# Main
# -----------------------------------------------------------------------------
main() {
    check_gum || true

    DRY_RUN=false
    PRUNE=false

    # Parse arguments
    SRC=""
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --help|-h)
                show_help
                exit 0
                ;;
            --dry-run|-n)
                DRY_RUN=true
                shift
                ;;
            --prune)
                PRUNE=true
                shift
                ;;
            --src)
                if [[ -z "${2:-}" ]]; then
                    log_error "--src requires a path argument"
                    exit 1
                fi
                SRC="$2"
                shift 2
                ;;
            -*)
                log_error "Unknown option: $1"
                echo "Usage: sync-skills [--src PATH] [--dry-run] [--prune] [--help]" >&2
                exit 1
                ;;
            *)
                log_error "Unexpected argument: $1"
                exit 1
                ;;
        esac
    done

    # Source-of-truth skills directory (each skill is a folder)
    SRC="${SRC:-$GLOBAL_SKILLS_DIR}"

    if [ ! -d "$SRC" ]; then
        log_error "SRC directory not found: $SRC"
        exit 1
    fi

    CLAUDE_SKILLS="${CLAUDE_SKILLS:-$HOME/.claude/skills}"
    CODEX_SKILLS="${CODEX_SKILLS:-${CODEX_HOME:-$HOME/.codex}/skills}"
    GEMINI_SKILLS="${GEMINI_SKILLS:-${GEMINI_HOME:-$HOME/.gemini}/skills}"

    mkdir -p "$CLAUDE_SKILLS" "$CODEX_SKILLS" "$GEMINI_SKILLS"

    # Count skills
    SKILL_COUNT=$(find "$SRC" -maxdepth 1 -mindepth 1 -type d 2>/dev/null | wc -l | tr -d ' ')

    print_banner

    if $DRY_RUN; then
        log_info "[DRY RUN] Would sync $SKILL_COUNT skills"
    else
        log_info "Syncing $SKILL_COUNT skills"
    fi
    log_step "Source: $SRC"
    echo ""

    # Collect skill names for summary
    SKILL_NAMES=()
    shopt -s nullglob
    for d in "$SRC"/*/; do
        SKILL_NAMES+=("$(basename "$d")")
    done
    shopt -u nullglob

    # Track stats per destination
    CLAUDE_NEW=0 CLAUDE_UPD=0 CLAUDE_PRUNE=0
    CODEX_NEW=0 CODEX_UPD=0 CODEX_PRUNE=0
    GEMINI_NEW=0 GEMINI_UPD=0 GEMINI_PRUNE=0

    skill_in_source() {
        local needle="$1"
        local skill=""

        for skill in "${SKILL_NAMES[@]}"; do
            if [[ "$skill" == "$needle" ]]; then
                return 0
            fi
        done

        return 1
    }

    sync_one_dest() {
        local dest="$1"
        local name="$2"
        local rsync_opts=("-aL" "--delete")
        $DRY_RUN && rsync_opts=("-aLn" "--delete")

        local new_count=0
        local update_count=0
        local prune_count=0

        if [[ "$GUM_AVAILABLE" == "true" ]]; then
            gum style --foreground 214 --bold "$name"
        else
            echo -e "${BOLD}${YELLOW}$name${NC}"
        fi

        for skill in "${SKILL_NAMES[@]}"; do
            local src_skill="$SRC/$skill"
            local dest_skill="$dest/$skill"
            local is_new=false

            # Check if skill exists at destination
            if [[ ! -d "$dest_skill" ]]; then
                is_new=true
            fi

            if $DRY_RUN; then
                if $is_new; then
                    if [[ "$GUM_AVAILABLE" == "true" ]]; then
                        gum style --foreground 39 "  + $skill (new)"
                    else
                        echo -e "  ${CYAN}+${NC} $skill ${DIM}(new)${NC}"
                    fi
                    ((new_count++))
                else
                    if [[ "$GUM_AVAILABLE" == "true" ]]; then
                        gum style --foreground 245 "  â†’ $skill (update)"
                    else
                        echo -e "  ${DIM}â†’ $skill (update)${NC}"
                    fi
                    ((update_count++))
                fi
            else
                mkdir -p "$dest_skill"
                rsync "${rsync_opts[@]}" "$src_skill/" "$dest_skill/" > /dev/null 2>&1

                if $is_new; then
                    if [[ "$GUM_AVAILABLE" == "true" ]]; then
                        gum style --foreground 39 "  + $skill (new)"
                    else
                        echo -e "  ${CYAN}+${NC} $skill ${DIM}(new)${NC}"
                    fi
                    ((new_count++))
                else
                    if [[ "$GUM_AVAILABLE" == "true" ]]; then
                        gum style --foreground 82 "  âœ“ $skill (updated)"
                    else
                        echo -e "  ${GREEN}âœ“${NC} $skill ${DIM}(updated)${NC}"
                    fi
                    ((update_count++))
                fi
            fi
        done

        if $PRUNE; then
            shopt -s nullglob
            for dir in "$dest"/*/; do
                local dest_skill
                dest_skill="$(basename "$dir")"

                if ! skill_in_source "$dest_skill"; then
                    if $DRY_RUN; then
                        if [[ "$GUM_AVAILABLE" == "true" ]]; then
                            gum style --foreground 196 "  - $dest_skill (prune)"
                        else
                            echo -e "  ${RED}-${NC} $dest_skill ${DIM}(prune)${NC}"
                        fi
                    else
                        if command -v trash &> /dev/null; then
                            trash "$dir"
                        else
                            rm -rf "$dir"
                        fi

                        if [[ "$GUM_AVAILABLE" == "true" ]]; then
                            gum style --foreground 196 "  - $dest_skill (pruned)"
                        else
                            echo -e "  ${RED}-${NC} $dest_skill ${DIM}(pruned)${NC}"
                        fi
                    fi

                    ((prune_count++))
                fi
            done
            shopt -u nullglob
        fi
        echo ""

        # Store counts based on destination name
        case "$name" in
            Claude) CLAUDE_NEW=$new_count; CLAUDE_UPD=$update_count; CLAUDE_PRUNE=$prune_count ;;
            Codex)  CODEX_NEW=$new_count;  CODEX_UPD=$update_count;  CODEX_PRUNE=$prune_count ;;
            Gemini) GEMINI_NEW=$new_count; GEMINI_UPD=$update_count; GEMINI_PRUNE=$prune_count ;;
        esac
    }

    sync_one_dest "$CLAUDE_SKILLS" "Claude"
    sync_one_dest "$CODEX_SKILLS" "Codex"
    sync_one_dest "$GEMINI_SKILLS" "Gemini"

    # Summary table
    if [[ "$GUM_AVAILABLE" == "true" ]]; then
        gum style --border rounded --border-foreground 212 --padding "0 1" --margin "0" -- \
            "$(printf "%-12s %5s %8s %7s\n" "Destination" "New" "Updated" "Pruned")" \
            "$(printf "%-12s %5s %8s %7s\n" "------------" "-----" "--------" "------")" \
            "$(printf "%-12s %5s %8s %7s\n" "Claude" "$CLAUDE_NEW" "$CLAUDE_UPD" "$CLAUDE_PRUNE")" \
            "$(printf "%-12s %5s %8s %7s\n" "Codex" "$CODEX_NEW" "$CODEX_UPD" "$CODEX_PRUNE")" \
            "$(printf "%-12s %5s %8s %7s\n" "Gemini" "$GEMINI_NEW" "$GEMINI_UPD" "$GEMINI_PRUNE")"
    else
        echo -e "${BOLD}Summary${NC}"
        echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”"
        echo "â”‚ Destination  â”‚ New â”‚ Updated â”‚ Pruned â”‚"
        echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
        printf "â”‚ %-12s â”‚ %3s â”‚ %7s â”‚ %6s â”‚\n" "Claude" "$CLAUDE_NEW" "$CLAUDE_UPD" "$CLAUDE_PRUNE"
        printf "â”‚ %-12s â”‚ %3s â”‚ %7s â”‚ %6s â”‚\n" "Codex" "$CODEX_NEW" "$CODEX_UPD" "$CODEX_PRUNE"
        printf "â”‚ %-12s â”‚ %3s â”‚ %7s â”‚ %6s â”‚\n" "Gemini" "$GEMINI_NEW" "$GEMINI_UPD" "$GEMINI_PRUNE"
        echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
    fi

    echo ""
    if $DRY_RUN; then
        log_info "[DRY RUN] No changes made"
    else
        log_success "All skills synced!"
    fi
}

main "$@"
